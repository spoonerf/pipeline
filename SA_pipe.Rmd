---
title: "SA_pipe"
author: "Fiona Spooner"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r Sourcing}
source(here::here("combine/FS","pat.R"))
source("SA_pipeline_functions.R")

```


```{r Libraries}
#devtools::install_github("https://github.com/hferg/sdmpl", auth_token = GITHUB_PAT)

library(CoordinateCleaner)
library(dplyr)
library(here)
library(lwgeom)
library(raster)
library(readr)
#library(sdmpl)
library(sf)
```

# Data Preparation 

We are only interested in species that occur in the study region - 'montane grasslands and shrublands' biome, below 21o south, in Africa (ext_sp). We will download all occurrences for these species south of the equator in Africa (ext_occ).
```{r Data preparation - setting extent}

bm<-st_read(here::here("WWF_Ecoregions/Species_Selection_Area_True.shp"))
ext_sp<-extent(bm)

xmin <- 4
xmax <- 59 # could be 52 if we don't want to include Mauritius 
ymin <- -35
ymax <- 0
 
ext_occ<-extent(xmin, xmax, ymin, ymax)

```


Removing species we aren't interested in e.g. fish. Leaving out birds for now as they all have large number of occurrences
```{r List of Species - gathered from SANBI}
gbif_all <- read.csv("D:/Fiona/SHEFS/GBIF/Species_List/All_GBIF_Species_List.csv", stringsAsFactors = FALSE)

g_sp <- gbif_all %>% 
  dplyr::filter(!is.na(species) & (class == "Mammalia" | class == "Gastropoda" | class == "Reptilia" |# class == "Aves" | 
           order == "Lepidoptera" | order == "Odonata" | order == "Hemiptera" | order == "Anura" | 
           order == "Neuroptera" | order == "Scorpiones" | order == "Araneae" | order == "Rodentia" |
           family == "Geotrupidae" | family == "Scarabaeidae" | family == "Viperidae" | family == "Lamprophiidae" |
           family == "Colubridae"  | family == "Elapidae" | family == "Pythonidae" | family == "Typhlopidae")) %>% 
  dplyr::select(species) %>% 
  distinct() 
```


```{r}
sanbi_all <- 
  do.call(rbind,
          lapply(list.files(path = "D:/Fiona/SHEFS/SANBI/Species_List", pattern = "*.csv", full.names = TRUE), read.csv))

s_sp <- na.omit(unique(as.character(sanbi_all$Binomial)))

s_sp<-s_sp[!s_sp %in% g_sp$species]

all_sp<-c(g_sp$species, s_sp)

``` 

Get the taxonomy of the species gathered from SANBI - if needed 

```{r, eval = FALSE}
# 
# tr_out<-lapply(s_sp[1:10], tax_out)
# 
# san_df<-do.call(rbind, tr_out)
# 
# all_sp<-rbind(g_sp, san_df)

```

```{r Downloading data from GBIF and cleaning it before outputting}

#gbifData(all_sp$species[1], ext = ext)

spxy_out <- lapply(all_sp[1:100], gbifData, ext_sp = ext_sp, ext_occ = ext_occ)

sp_df <- data.frame(do.call(rbind, spxy_out))

sp_df$species <- as.character(sp_df$species)
sp_df$x <- as.numeric(as.character(sp_df$x))
sp_df$y <- as.numeric(as.character(sp_df$y))

```



##Coordinate Cleaner
```{r}

sp_cc <- clean_coordinates(sp_df, lon = "x", lat = "y", species = "species")

sp_df<-sp_df[which(sp_cc$.summary == TRUE),]

```


###Environmental Data Prep
```{r}
env_layers <- loadBioclim(path = here::here("CHELSA/"), extension = ".tif")
env_crop <- crop(env_layers, ext)


```


###Rarefy Points
```{r}
rarefyPoints()

```


###Extract Data
```{r}

```


###Background Data
```{r}

ecoreg <-
  sf::st_read(here::here("WWF_Ecoregions/official/wwf_terr_ecos.shp"))

ecoreg <- ecoreg %>%
  dplyr::select(OBJECTID, ECO_NAME)   ##just selecting out the columns we're interested in

occ_files <-
  list.files(
    here::here("GBIF/Occurences/Network_Groups/"),
    pattern = "*.csv",
    full.names = TRUE,
    recursive = TRUE
  )


background_sampler <- function(occ_file, no_pnts) {
  sf_int <- read_csv(occ_file) %>%
    dplyr::select("decimalLongitude", "decimalLatitude") %>%
    dplyr::distinct() %>%
    sf::st_as_sf(.,
             coords = c("decimalLongitude", "decimalLatitude"),
             crs = 4326) %>%
    sf::st_intersection(., ecoreg)
  
  bkg_ecoreg <- ecoreg %>%
    dplyr::filter(ECO_NAME %in% sf_int$ECO_NAME) %>%
    sf::st_sample(., size = no_pnts, type = "random")
  
  print(basename(occ_file))
  return(bkg_ecoreg)
}




```

###Fit Models
```{r}


```

###Evaluate Models
```{r}


```

###Build Ensemble Model
```{r}

```


###Predict Forward
```{r}


```
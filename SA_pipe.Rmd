---
title: "SA_pipe"
author: "Fiona Spooner"
date: "11/11/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

```{r Sourcing}
source(here::here("combine/FS","pat.R"))
source("SA_pipeline_functions.R")

```


```{r Libraries}
#devtools::install_github("https://github.com/hferg/sdmpl", auth_token = GITHUB_PAT)

set.seed(2237)

library(CoordinateCleaner)
library(dplyr)
library(here)
library(lwgeom)
library(raster)
library(readr)
#library(sdmpl)
library(sf)
```

# Data Preparation 

We are only interested in species that occur in the study region - 'montane grasslands and shrublands' biome, below 21o south, in Africa (ext_sp). We will download all occurrences for these species south of the equator in Africa (ext_occ).
```{r Data preparation - setting extent}

bm<-st_read(here::here("WWF_Ecoregions/Species_Selection_Area_True.shp"))
ext_sp<-extent(bm)

xmin <- 4
xmax <- 59 # could be 52 if we don't want to include Mauritius 
ymin <- -35
ymax <- 0
 
ext_occ<-extent(xmin, xmax, ymin, ymax)

```

###Environmental Data Prep
```{r}

env_layers <- loadBioclim(path = here::here("CHELSA/"), extension = ".tif")
env_crop <- crop(env_layers, ext_occ)

```


Removing species we aren't interested in e.g. fish. Leaving out birds for now as they all have large number of occurrences
```{r List of Species - gathered from SANBI}
gbif_all <- read.csv("D:/Fiona/SHEFS/GBIF/Species_List/All_GBIF_Species_List.csv", stringsAsFactors = FALSE)

g_sp <- gbif_all %>% 
  dplyr::filter(!is.na(species) & (class == "Mammalia" | class == "Gastropoda" | class == "Reptilia" |# class == "Aves" | 
           order == "Lepidoptera" | order == "Odonata" | order == "Hemiptera" | order == "Anura" | 
           order == "Neuroptera" | order == "Scorpiones" | order == "Araneae" | order == "Rodentia" |
           family == "Geotrupidae" | family == "Scarabaeidae" | family == "Viperidae" | family == "Lamprophiidae" |
           family == "Colubridae"  | family == "Elapidae" | family == "Pythonidae" | family == "Typhlopidae")) %>% 
  dplyr::select(species) %>% 
  distinct() 
```


```{r}
sanbi_all <- 
  do.call(rbind,
          lapply(list.files(path = "D:/Fiona/SHEFS/SANBI/Species_List", pattern = "*.csv", full.names = TRUE), read.csv))

s_sp <- na.omit(unique(as.character(sanbi_all$Binomial)))

s_sp<-s_sp[!s_sp %in% g_sp$species]

all_sp<-c(g_sp$species, s_sp)

``` 

Get the taxonomy of the species gathered from SANBI - if needed 

```{r, eval = FALSE}
# 
# tr_out<-lapply(s_sp[1:10], tax_out)
# 
# san_df<-do.call(rbind, tr_out)
# 
# all_sp<-rbind(g_sp, san_df)

```

```{r Downloading data from GBIF and cleaning it before outputting}

#gbifData(all_sp$species[1], ext = ext)

spxy_out <- lapply(all_sp[14], gbifData, ext_sp = ext_sp, ext_occ = ext_occ)

sp_df <- data.frame(do.call(rbind, spxy_out))

sp_df$species <- as.character(sp_df$species)
sp_df$x <- as.numeric(as.character(sp_df$x))
sp_df$y <- as.numeric(as.character(sp_df$y))

```



##Coordinate Cleaner
```{r}

sp_cc <- clean_coordinates(sp_df, lon = "x", lat = "y", species = "species")

sp_df<-sp_df[which(sp_cc$.summary == TRUE),]

```





###Rarefy Points
```{r}
rarefySpeciesPoints<-function(species){
  
  df <- sp_df[sp_df$species == species,]
  df_xy <- SpatialPointsDataFrame(matrix(c(df$x, df$y), ncol = 2), df)
  df_rar <- data.frame(species,rarefyPoints(env_crop[[1]], df_xy))

  print(species)
  return(df_rar)
  
  }


rarefy_out <- lapply(unique(sp_df$species), rarefySpeciesPoints)
#r_sp_df <- do.call(rbind, rarefy_out)

#rarefy_out[sapply(rarefy_out, is.null)] <- NULL

output_csv <- function(data, names){ 
    folder_path <- here::here("points/presence/")
    write_csv(data, paste0(folder_path,"/", names, ".csv"))
  }

list(data = rarefy_out,
     names = gsub(" ","_",unique(sp_df$species))) %>% 
     purrr::pmap(output_csv) 


###should try and filter out sp with less than 10 occurrences at this point

```


###Extract Data
```{r}
pr_in_files <-
  list.files(here::here("points/presence/"),
             full.names = TRUE,
             pattern = "*.csv")

pr_out_files <-
  paste0(here::here("environmental/presence"),
         "/",
         basename(pr_in_files))


mapply(ras_extract, in_file = pr_in_files, out_file = pr_out_files)

```


###Background Data
```{r}


ecoreg <-
  sf::st_read(here::here("WWF_Ecoregions/wwf_terr_ecos.shp"))

ecoreg <- ecoreg %>%
  dplyr::select(OBJECTID, ECO_NAME)   ##just selecting out the columns we're interested in

bg_in_files <-
  list.files(
    here::here("points/presence/"),
    pattern = "*.csv",
    full.names = TRUE
  )

bg_out_files <- paste0(here::here("points/background/"),
         "/",
         basename(bg_in_files))


mapply(background_sampler, in_file = bg_in_files[2], no_pnts = 10000, out_file = bg_out_files[2])

```


```{r}


bg_ex_in_files <- list.files(here::here("points/background/"),
                             pattern = "*.csv",
                             full.names = TRUE)

bg_ex_out_files <- paste0(here::here("environmental/background/"),
                          "/",
                          basename(bg_ex_in_files))


mapply(ras_extract, in_file = bg_ex_in_files, out_file = bg_ex_out_files)

```


###Fit Bioclim
```{r}


sp_names <- gsub("*.csv","",list.files(here::here("environmental/presence"),
              pattern = "*.csv"))

sp_names <- sp_names[sp_names %in% gsub(".csv","",list.files(here::here("environmental/background")))]


lapply(
  X = sp_names[2],
  fitBC,
  pres_dir = here::here("environmental/presence"),
  backg_dir = here::here("environmental/background"),
  predictor_names = c(1, 3, 4, 12),
  predictors = env_crop,
  pred_out_dir = here::here("predictions/bioclim/"),
  eval_out_dir = here::here("evaluation/bioclim/"),
  overwrite = TRUE,
  threads = 4,
  eval = TRUE
)


```



###Fit GLM
```{r}

lapply(
  X = sp_names[2],
  fitGLM,
  pres_dir = here::here("environmental/presence"),
  backg_dir = here::here("environmental/background"),
  predictor_names = c(1, 3, 4, 12),
  predictors = env_crop,
  pred_out_dir = here::here("predictions/glm/"),
  eval_out_dir = here::here("evaluation/glm/"),
  overwrite = TRUE,
  threads = 4,
  eval = TRUE
)


```

###Fit RF
```{r}


lapply(
  X = sp_names[2],
  fitRF,
  pres_dir = here::here("environmental/presence"),
  backg_dir = here::here("environmental/background"),
  predictor_names = c(1, 3, 4, 12),
  predictors = env_crop,
  pred_out_dir = here::here("predictions/rf/"),
  eval_out_dir = here::here("evaluation/rf/"),
  overwrite = TRUE,
  threads = 4,
  eval = TRUE
)


```


###Get Evaluations and AUCs
```{r}

sp_name <- "Bitis_arietans"   

eval_files <-  list.files(here::here("evaluation/"), full.names = TRUE, recursive = TRUE, pattern = "*eval")[grepl(sp_name, list.files(here::here("evaluation/"), full.names = TRUE, recursive = TRUE,pattern = "*eval"))]

eval_mean <- function(eval_file, threshold = "tss"){
  
  load(eval_file)
  model <- evals$model
  species <- evals$sp_name
  
  aucs <- mean(sapply(evals$aucs, function(x) x@auc))

  if (model == "glm"){
  thresholds  <- mean(exp(evals$thresholds[[threshold]])/(1 + exp(evals$thresholds[[threshold]])))
  } else {
  thresholds  <- mean(evals$thresholds[[threshold]])
  }

  df_out <- data.frame(sp_name = sp_name,model = model, auc = aucs, threshold = thresholds)
  return(df_out)
  }

eval_mean(eval_files[[1]], threshold = "tss")

evals_out <- lapply(eval_files, eval_mean, threshold = "tss")


```
###Build Ensemble Model
```{r}

preds <- list.files(here::here("predictions"), full.names = TRUE, recursive = TRUE)[grepl(sp_name, list.files(here::here("predictions"), full.names = TRUE, recursive = TRUE))]
preds <- stack(preds)
  

# pred <- raster::subset(preds, subset = layer_name)
  # 
  # pa <- pred >= thresholds
  # 

```

###Predict Forward
```{r}


```